name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      id-token: write
    env:
      TARGET_VERSION: ${{ github.event.inputs.target_version }}
      IS_DRY_RUN: ${{ github.event.inputs.dry_run }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      NPM_CONFIG_PROVENANCE: true
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          echo "ğŸ“¦ æ›´æ–°ç‰ˆæœ¬å·åˆ°: $TARGET_VERSION"

          for pkg in packages/*/; do
            if [[ -d "$pkg" && -f "$pkg/package.json" ]]; then
              echo "ğŸ”„ $(basename "$pkg")"
              npm version "$TARGET_VERSION" --no-git-tag-version --allow-same-version --prefix "$pkg"
            fi
          done

      - name: æ„å»ºå’Œå‘å¸ƒ
        run: |
          pnpm build:packages

          if [[ "$TARGET_VERSION" =~ -(beta|rc)\.[0-9]+$ ]]; then
            PUBLISH_TAG="beta"
          else
            PUBLISH_TAG="latest"
          fi

          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "ğŸ” é¢„æ¼”æ¨¡å¼: å°†å‘å¸ƒä»¥ä¸‹åŒ…åˆ° $PUBLISH_TAG æ ‡ç­¾"
            for pkg in packages/*/; do
              if [[ -d "$pkg" && -f "$pkg/package.json" ]]; then
                pkg_name=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$pkg/package.json', 'utf8')).name)")
                echo "  - $pkg_name@$TARGET_VERSION"
              fi
            done
            echo "âœ… é¢„æ¼”å®Œæˆ"
          else
            echo "ğŸ“¤ å‘å¸ƒåˆ° npm ($PUBLISH_TAG æ ‡ç­¾)..."

            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git add packages/*/package.json
            git commit -m "chore: å‘å¸ƒç‰ˆæœ¬ $TARGET_VERSION [skip ci]"

            # å‘å¸ƒæ‰€æœ‰åŒ…
            for pkg in packages/*/; do
              if [[ -d "$pkg" && -f "$pkg/package.json" ]]; then
                pkg_name=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$pkg/package.json', 'utf8')).name)")
                echo "ğŸ“¦ å‘å¸ƒ: $pkg_name"
                cd "$pkg"
                npm publish --tag "$PUBLISH_TAG" --access public
                cd - > /dev/null
              fi
            done

            # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
            echo "ğŸ·ï¸ åˆ›å»º Git æ ‡ç­¾..."
            git tag -a "bestmcp@$TARGET_VERSION" -m "bestmcp@$TARGET_VERSION"
            git tag -a "@bestmcp/client@$TARGET_VERSION" -m "@bestmcp/client@$TARGET_VERSION"
            git tag -a "@bestmcp/server@$TARGET_VERSION" -m "@bestmcp/server@$TARGET_VERSION"

            # æ¨é€å˜æ›´å’Œæ ‡ç­¾
            echo "ğŸ”„ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
            git push origin "${{ github.ref_name }}"
            git push origin "bestmcp@$TARGET_VERSION" "@bestmcp/client@$TARGET_VERSION" "@bestmcp/server@$TARGET_VERSION"

            echo "âœ… å‘å¸ƒå®Œæˆ"
          fi
