name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
            echo "   - æ­£å¼ç‰ˆ: 1.0.0"
            echo "   - Betaç‰ˆ: 1.0.0-beta.0"
            echo "   - RCç‰ˆ: 1.0.0-rc.0"
            exit 1
          fi

          # æ£€æŸ¥åˆ†æ”¯æƒé™ï¼ˆå…è®¸åœ¨featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•å‘å¸ƒï¼‰
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® npm è®¤è¯
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„è¿‡æ—¶é…ç½®
          npm config delete always-auth 2>/dev/null || true
          npm config delete _auth 2>/dev/null || true
          npm config delete authtoken 2>/dev/null || true

          # è®¾ç½®æ ‡å‡†è®¤è¯é…ç½®
          echo "//registry.npmjs.org/:_authToken=\${NODE_AUTH_TOKEN}" > ~/.npmrc
          npm config set registry https://registry.npmjs.org/

          # éªŒè¯é…ç½®
          echo "âœ… npm é…ç½®å®Œæˆ:"
          echo "   - registry: $(npm config get registry)"
          echo "   - always-auth: $(npm config get always-auth 2>/dev/null || echo 'æœªè®¾ç½®')"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è§£æç‰ˆæœ¬å·
        id: parse-version
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # æ­£å¼ç‰ˆ: 1.0.0
            VERSION_TYPE="release"
            PRERELEASE_ID=""
            echo "æ£€æµ‹åˆ°æ­£å¼ç‰ˆç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$ ]]; then
            # Beta ç‰ˆ: 1.0.0-beta.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="beta"
            echo "æ£€æµ‹åˆ°Betaç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
            # RC ç‰ˆ: 1.0.0-rc.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="rc"
            echo "æ£€æµ‹åˆ°RCç‰ˆæœ¬å·: $TARGET_VERSION"
          else
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ³•è¯†åˆ«"
            exit 1
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT

      - name: ç‰ˆæœ¬é¢„æ£€æŸ¥
        run: |
          echo "ğŸ” ç‰ˆæœ¬é¢„æ£€æŸ¥..."
          ROOT_VERSION=$(node -p "require('./package.json').version")
          CLIENT_VERSION=$(node -p "require('./packages/client/package.json').version")
          SERVER_VERSION=$(node -p "require('./packages/server/package.json').version")

          echo "å½“å‰ç‰ˆæœ¬çŠ¶æ€ï¼š"
          echo "   - æ ¹ç›®å½• (bestmcp): $ROOT_VERSION"
          echo "   - Client (@bestmcp/client): $CLIENT_VERSION"
          echo "   - Server (@bestmcp/server): $SERVER_VERSION"

          if [ "$ROOT_VERSION" != "$CLIENT_VERSION" ] || [ "$ROOT_VERSION" != "$SERVER_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸åŒæ­¥ï¼æ­£åœ¨è‡ªåŠ¨åŒæ­¥..."
            TARGET_VERSION="$ROOT_VERSION"

            # æ›´æ–°å­åŒ…ç‰ˆæœ¬
            npm version "$TARGET_VERSION" --no-git-tag-version --workspaces-update false
            cd packages/client && npm version "$TARGET_VERSION" --no-git-tag-version && cd ../..
            cd packages/server && npm version "$TARGET_VERSION" --no-git-tag-version && cd ../..

            echo "âœ… ç‰ˆæœ¬å·²åŒæ­¥åˆ°: $TARGET_VERSION"
          else
            echo "âœ… ç‰ˆæœ¬åŒæ­¥æ­£å¸¸"
          fi

      - name: æ£€æŸ¥ç›®æ ‡ç‰ˆæœ¬å†²çª
        id: version-check
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          VERSION_TYPE="${{ steps.parse-version.outputs.version_type }}"
          echo "ğŸ” æ£€æŸ¥ç›®æ ‡ç‰ˆæœ¬ $TARGET_VERSION (ç±»å‹: $VERSION_TYPE) æ˜¯å¦å·²å­˜åœ¨..."

          # é…ç½®ä¸´æ—¶è®¤è¯ï¼ˆåªç”¨äºæ£€æŸ¥ï¼‰
          echo "//registry.npmjs.org/:_authToken=\${NODE_AUTH_TOKEN}" > ~/.npmrc_temp
          npm config set registry https://registry.npmjs.org/
          export npm_config_userconfig=~/.npmrc_temp

          CONFLICTS=0

          # å¯¹äºé¢„å‘å¸ƒç‰ˆï¼Œä½¿ç”¨ä¸åŒçš„æ£€æŸ¥ç­–ç•¥
          if [ "$VERSION_TYPE" = "prerelease" ]; then
            echo "ğŸ“¦ é¢„å‘å¸ƒç‰ˆæ£€æŸ¥ï¼šè·³è¿‡ npm registry æ£€æŸ¥ï¼Œå…è®¸è¦†ç›–å‘å¸ƒ"
            echo "â„¹ï¸  é¢„å‘å¸ƒç‰ˆæœ¬é€šå¸¸ä¸å­˜åœ¨äº registryï¼Œè¿™æ˜¯æ­£å¸¸çš„"
          else
            echo "ğŸ“¦ æ­£å¼ç‰ˆæ£€æŸ¥ï¼šéªŒè¯ç‰ˆæœ¬å”¯ä¸€æ€§"
            # æ£€æŸ¥å„ä¸ªåŒ…çš„ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
            for PKG in "bestmcp" "@bestmcp/client" "@bestmcp/server"; do
              echo "   æ£€æŸ¥ $PKG@$TARGET_VERSION..."
              if npm view "$PKG@$TARGET_VERSION" --json --silent 2>/dev/null | grep -q '"name"'; then
                echo "âš ï¸  $PKG@$TARGET_VERSION å·²å­˜åœ¨äº npm registry"
                CONFLICTS=$((CONFLICTS + 1))
              else
                echo "âœ… $PKG@$TARGET_VERSION å¯ç”¨"
              fi
            done
          fi

          # æ¸…ç†ä¸´æ—¶é…ç½®
          rm -f ~/.npmrc_temp

          echo "conflicts=$CONFLICTS" >> $GITHUB_OUTPUT

          if [ $CONFLICTS -gt 0 ]; then
            echo "âš ï¸  æ£€æµ‹åˆ° $CONFLICTS ä¸ªç‰ˆæœ¬å†²çªï¼Œä½†å°†å¼ºåˆ¶å‘å¸ƒ"
          else
            echo "âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡"
          fi

      - name: å‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          CONFLICTS="${{ steps.version-check.outputs.conflicts }}"
          RELEASE_CMD="npx release-it --ci --verbose"

          if [ "${{ steps.parse-version.outputs.version_type }}" = "release" ]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD -i $TARGET_VERSION"
          else
            # é¢„å‘å¸ƒç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD $TARGET_VERSION --preRelease=${{ steps.parse-version.outputs.prerelease_id }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
          fi

          echo "ğŸ“¦ å¼€å§‹å‘å¸ƒæµç¨‹..."
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          echo "   - ç›®æ ‡ç‰ˆæœ¬: $TARGET_VERSION"
          echo "   - ç‰ˆæœ¬ç±»å‹: ${{ steps.parse-version.outputs.version_type }}"
          echo "   - é¢„å‘å¸ƒID: ${{ steps.parse-version.outputs.prerelease_id }}"
          echo "   - å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          echo "   - ç‰ˆæœ¬å†²çªæ•°: $CONFLICTS"
          echo "   - æ‰§è¡Œå‘½ä»¤: $RELEASE_CMD"
          echo ""

          # æ£€æŸ¥ç¯å¢ƒ
          echo "ğŸ” ç¯å¢ƒæ£€æŸ¥ï¼š"
          echo "   - Nodeç‰ˆæœ¬: $(node --version)"
          echo "   - pnpmç‰ˆæœ¬: $(pnpm --version)"
          echo "   - npmç‰ˆæœ¬: $(npm --version)"
          echo "   - å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "   - GitçŠ¶æ€: $(git status --porcelain | wc -l) ä¸ªæ–‡ä»¶æœ‰ä¿®æ”¹"

          # è¯¦ç»†çš„ Git çŠ¶æ€æ£€æŸ¥
          echo ""
          echo "ğŸ” Git è¯¦ç»†çŠ¶æ€ï¼š"
          if [ -n "$(git status --porcelain)" ]; then
            echo "   - æœªæäº¤çš„æ–‡ä»¶ï¼š"
            git status --porcelain | head -10 | while read line; do
              echo "     $line"
            done
            echo "   - æ³¨æ„ï¼šrelease-it ä¼šè‡ªåŠ¨æäº¤è¿™äº›æ›´æ”¹"
          else
            echo "   - âœ… å·¥ä½œç›®å½•å¹²å‡€"
          fi

          echo "   - æœ€åä¸€æ¬¡æäº¤: $(git log -1 --oneline)"
          echo "   - è¿œç¨‹åˆ†æ”¯çŠ¶æ€: $(git branch -r --contains HEAD | wc -l) ä¸ªè¿œç¨‹åˆ†æ”¯åŒ…å«å½“å‰æäº¤"
          echo ""

          # éªŒè¯è®¤è¯é…ç½®
          echo "ğŸ” è®¤è¯æ£€æŸ¥ï¼š"
          echo "   - npm registry: $(npm config get registry)"
          echo "   - npm è®¤è¯çŠ¶æ€: $(npm whoami 2>/dev/null || echo 'æœªè®¤è¯')"
          echo ""

          # æ£€æŸ¥å½“å‰åŒ…ç‰ˆæœ¬çŠ¶æ€
          echo "ğŸ“¦ å½“å‰åŒ…ç‰ˆæœ¬çŠ¶æ€ï¼š"
          echo "   - æ ¹ç›®å½•ç‰ˆæœ¬: $(node -p "require('./package.json').version")"
          echo "   - Clientç‰ˆæœ¬: $(node -p "require('./packages/client/package.json').version")"
          echo "   - Serverç‰ˆæœ¬: $(node -p "require('./packages/server/package.json').version")"
          echo ""

          # æ¸…ç† npm ç¼“å­˜ï¼ˆé¿å…ç¼“å­˜é—®é¢˜ï¼‰
          echo "ğŸ§¹ æ¸…ç† npm ç¼“å­˜..."
          npm cache clean --force 2>/dev/null || true

          # å¦‚æœå­˜åœ¨å†²çªï¼Œå‡†å¤‡å¼ºåˆ¶å‘å¸ƒ
          if [ "$CONFLICTS" -gt 0 ]; then
            echo "âš ï¸  æ£€æµ‹åˆ°ç‰ˆæœ¬å†²çªï¼Œå°†ä½¿ç”¨å¼ºåˆ¶å‘å¸ƒæ¨¡å¼"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œå¹¶è‡ªåŠ¨å¤„ç†
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ å‘ç°æœªæäº¤çš„æ›´æ”¹ï¼Œå‡†å¤‡è‡ªåŠ¨æäº¤..."
            git add -A
            git commit -m "chore: å‘å¸ƒå‰è‡ªåŠ¨æäº¤ç‰ˆæœ¬æ›´æ–°

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            echo "âœ… å·²è‡ªåŠ¨æäº¤ç‰ˆæœ¬æ›´æ”¹"
          fi

          # æ‰§è¡Œå‘å¸ƒå‘½ä»¤
          echo "ğŸš€ æ‰§è¡Œå‘å¸ƒå‘½ä»¤..."

          # æ‰§è¡Œå‘å¸ƒå¹¶æ•è·é”™è¯¯
          if ! eval "$RELEASE_CMD"; then
            echo "âŒ å‘å¸ƒå¤±è´¥ï¼"
            echo "ğŸ“‹ é”™è¯¯è¯Šæ–­ï¼š"
            echo "   - æ£€æŸ¥ npm æ—¥å¿—: /home/runner/.npm/_logs/"
            echo "   - æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å†²çª"
            echo "   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæƒé™"
            echo "   - éªŒè¯åŒ…ç‰ˆæœ¬é…ç½®"
            echo "   - ç‰ˆæœ¬å†²çªæ•°: $CONFLICTS"

            # è¾“å‡ºè¯¦ç»†çš„ npm è°ƒè¯•ä¿¡æ¯
            echo ""
            echo "ğŸ” è¯¦ç»†è¯Šæ–­ä¿¡æ¯ï¼š"
            npm config list
            echo ""
            echo "ğŸ“‹ npm é”™è¯¯æ—¥å¿—ï¼ˆæœ€è¿‘5æ¡ï¼‰ï¼š"
            ls -la /home/runner/.npm/_logs/ 2>/dev/null | tail -5 || echo "æ— æ³•è®¿é—®æ—¥å¿—ç›®å½•"

            # è¾“å‡ºå…·ä½“çš„ npm æ—¥å¿—å†…å®¹
            echo ""
            echo "ğŸ“‹ æœ€æ–° npm é”™è¯¯æ—¥å¿—å†…å®¹ï¼š"
            find /home/runner/.npm/_logs/ -name "*debug-0.log" -exec tail -20 {} \; 2>/dev/null | head -50 || echo "æ— æ³•è¯»å–æ—¥å¿—å†…å®¹"

            exit 1
          fi

          echo "âœ… å‘å¸ƒå‘½ä»¤æ‰§è¡Œå®Œæˆï¼"
