name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
            echo "   - æ­£å¼ç‰ˆ: 1.0.0"
            echo "   - Betaç‰ˆ: 1.0.0-beta.0"
            echo "   - RCç‰ˆ: 1.0.0-rc.0"
            exit 1
          fi

          # æ£€æŸ¥åˆ†æ”¯æƒé™ï¼ˆå…è®¸åœ¨featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•å‘å¸ƒï¼‰
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ‰‹åŠ¨æ›´æ–°ç‰ˆæœ¬å·
        run: |
          echo "ğŸ“¦ æ‰‹åŠ¨æ›´æ–°ç‰ˆæœ¬å·ä¸º: ${{ github.event.inputs.target_version }}"

          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆ: $TARGET_VERSION"
            exit 1
          fi

          # æ›´æ–°æ‰€æœ‰åŒ…çš„ç‰ˆæœ¬å·
          echo "ğŸ”„ æ›´æ–° packages/bestmcp/package.json"
          npm version "$TARGET_VERSION" --no-git-tag-version --prefix packages/bestmcp

          echo "ğŸ”„ æ›´æ–° packages/client/package.json"
          npm version "$TARGET_VERSION" --no-git-tag-version --prefix packages/client

          echo "ğŸ”„ æ›´æ–° packages/server/package.json"
          npm version "$TARGET_VERSION" --no-git-tag-version --prefix packages/server

          echo "âœ… æ‰€æœ‰åŒ…ç‰ˆæœ¬å·²æ›´æ–°ä¸º: $TARGET_VERSION"

      - name: å‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹å‘å¸ƒç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"

          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          # æ„å»ºæ‰€æœ‰åŒ…
          pnpm build:packages

          # ä»…å‘å¸ƒï¼Œä¸è¿›è¡Œç‰ˆæœ¬è®¡ç®—ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»æ‰‹åŠ¨è®¾ç½®äº†ç‰ˆæœ¬ï¼‰
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” é¢„æ¼”æ¨¡å¼ï¼šæ£€æŸ¥å°†è¦å‘å¸ƒçš„åŒ…..."
            pnpm changeset publish --dry-run
          else
            echo "ğŸ“¤ å‘å¸ƒåˆ° npm..."

            # ç¡®å®šå‘å¸ƒæ ‡ç­¾
            if [[ "$TARGET_VERSION" =~ -(beta|rc)\.[0-9]+$ ]]; then
              PUBLISH_TAG="beta"
              echo "ğŸ“‹ æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä½¿ç”¨æ ‡ç­¾: $PUBLISH_TAG"
            else
              PUBLISH_TAG="latest"
              echo "ğŸ“‹ æ£€æµ‹åˆ°æ­£å¼ç‰ˆæœ¬ï¼Œä½¿ç”¨æ ‡ç­¾: $PUBLISH_TAG"
            fi

            # æäº¤ç‰ˆæœ¬æ›´æ–°åˆ° git
            git add packages/*/package.json
            git commit -m "chore: å‘å¸ƒç‰ˆæœ¬ $TARGET_VERSION [skip ci]"

            # ç›´æ¥å‘å¸ƒå„ä¸ªåŒ…
            for pkg in packages/*/; do
              if [[ -d "$pkg" && -f "$pkg/package.json" ]]; then
                pkg_name=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$pkg/package.json', 'utf8')).name)")
                echo "ğŸ“¦ å‘å¸ƒåŒ…: $pkg_name@$TARGET_VERSION"
                cd "$pkg"
                npm publish --tag "$PUBLISH_TAG" --access public
                cd - > /dev/null
              fi
            done

            # æ‰‹åŠ¨åˆ›å»º git æ ‡ç­¾
            git tag -a "bestmcp@$TARGET_VERSION" -m "bestmcp@$TARGET_VERSION"
            git tag -a "@bestmcp/client@$TARGET_VERSION" -m "@bestmcp/client@$TARGET_VERSION"
            git tag -a "@bestmcp/server@$TARGET_VERSION" -m "@bestmcp/server@$TARGET_VERSION"

            # æ¨é€æäº¤å’Œæ ‡ç­¾
            CURRENT_BRANCH="${{ github.ref_name }}"
            if [[ "$CURRENT_BRANCH" == "main" ]]; then
              echo "ğŸ”„ æ¨é€å˜æ›´åˆ° main åˆ†æ”¯..."
              git push origin main
            else
              echo "ğŸ”„ æ¨é€å˜æ›´åˆ°å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
              git push origin "$CURRENT_BRANCH"
            fi

            git push origin "bestmcp@$TARGET_VERSION"
            git push origin "@bestmcp/client@$TARGET_VERSION"
            git push origin "@bestmcp/server@$TARGET_VERSION"

            echo "âœ… å‘å¸ƒå®Œæˆï¼Œå·²åˆ›å»ºå¹¶æ¨é€ git æ ‡ç­¾"
          fi
