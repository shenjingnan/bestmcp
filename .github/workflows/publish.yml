name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
            echo "   - æ­£å¼ç‰ˆ: 1.0.0"
            echo "   - Betaç‰ˆ: 1.0.0-beta.0"
            echo "   - RCç‰ˆ: 1.0.0-rc.0"
            exit 1
          fi

          # æ£€æŸ¥åˆ†æ”¯æƒé™ï¼ˆå…è®¸åœ¨featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•å‘å¸ƒï¼‰
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è§£æç‰ˆæœ¬å·
        id: parse-version
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # æ­£å¼ç‰ˆ: 1.0.0
            VERSION_TYPE="release"
            PRERELEASE_ID=""
            echo "æ£€æµ‹åˆ°æ­£å¼ç‰ˆç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$ ]]; then
            # Beta ç‰ˆ: 1.0.0-beta.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="beta"
            echo "æ£€æµ‹åˆ°Betaç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
            # RC ç‰ˆ: 1.0.0-rc.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="rc"
            echo "æ£€æµ‹åˆ°RCç‰ˆæœ¬å·: $TARGET_VERSION"
          else
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ³•è¯†åˆ«"
            exit 1
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT

      - name: å‡†å¤‡ Changesets
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          VERSION_TYPE="${{ steps.parse-version.outputs.version_type }}"

          echo "ğŸ“‹ å‡†å¤‡ Changesets å‘å¸ƒï¼š"
          echo "   - ç›®æ ‡ç‰ˆæœ¬: $TARGET_VERSION"
          echo "   - ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
          echo "   - å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          echo ""

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬ä¿¡æ¯
          rm -f .changeset/pre.json

          # åˆ›å»ºä¸´æ—¶çš„ changeset æ–‡ä»¶æ¥æŒ‡å®šç‰ˆæœ¬å·
          mkdir -p .changeset
          TIMESTAMP=$(date +%s)
          CHANGESET_FILE=".changeset/temp-release-$TIMESTAMP.md"
          echo "---" > $CHANGESET_FILE
          echo "\"bestmcp\": $VERSION_TYPE" >> $CHANGESET_FILE
          echo "\"@bestmcp/server\": $VERSION_TYPE" >> $CHANGESET_FILE
          echo "\"@bestmcp/client\": $VERSION_TYPE" >> $CHANGESET_FILE
          echo "---" >> $CHANGESET_FILE
          echo "" >> $CHANGESET_FILE
          echo "å‘å¸ƒæŒ‡å®šç‰ˆæœ¬ $TARGET_VERSION" >> $CHANGESET_FILE

          echo "âœ… Changeset æ–‡ä»¶å·²åˆ›å»º"

      - name: åº”ç”¨ç‰ˆæœ¬æ›´æ–°
        if: github.event.inputs.dry_run != 'true'
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          VERSION_TYPE="${{ steps.parse-version.outputs.version_type }}"

          echo "ğŸš€ åº”ç”¨ç‰ˆæœ¬æ›´æ–°åˆ° $TARGET_VERSION..."

          # åº”ç”¨ changesets ç‰ˆæœ¬æ›´æ–°
          pnpm changeset version

          # æ‰‹åŠ¨è®¾ç½®ç‰ˆæœ¬å·åˆ°æŒ‡å®šå€¼
          if [ "${{ steps.parse-version.outputs.version_type }}" = "release" ]; then
            # æ­£å¼ç‰ˆ
            pnpm -r --filter "./packages/**" exec npm version $TARGET_VERSION --no-git-tag-version
            npm version $TARGET_VERSION --no-git-tag-version
          else
            # é¢„å‘å¸ƒç‰ˆ
            PRERELEASE_VERSION="${TARGET_VERSION}-${{ steps.parse-version.outputs.prerelease_id }}"
            pnpm -r --filter "./packages/**" exec npm version $PRERELEASE_VERSION --no-git-tag-version
            npm version $PRERELEASE_VERSION --no-git-tag-version
          fi

          echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°"

      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
          pnpm clean
          pnpm build:packages
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

      - name: ç”Ÿæˆ CHANGELOG
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ“ ç”Ÿæˆ CHANGELOG..."
          pnpm changeset generate
          echo "âœ… CHANGELOG å·²ç”Ÿæˆ"

      - name: å‘å¸ƒåˆ° NPM
        if: github.event.inputs.dry_run != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          echo "ğŸ“¦ å‘å¸ƒåˆ° NPM..."
          pnpm changeset publish
          echo "âœ… NPM å‘å¸ƒå®Œæˆ"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        if: github.event.inputs.dry_run != 'true'
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"

          echo "ğŸ“ æäº¤ç‰ˆæœ¬æ›´æ–°..."
          git add .
          git commit -m "chore: release v$TARGET_VERSION"
          echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤"

      - name: åˆ›å»º Git Tag å’Œ GitHub Release
        if: github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"

          echo "ğŸ·ï¸ åˆ›å»º Git Tag å’Œ GitHub Release..."

          # åˆ›å»ºå¹¶æ¨é€ tag
          git tag v$TARGET_VERSION
          git push --follow-tags

          # åˆ›å»º GitHub Release
          RELEASE_TITLE="ğŸš€ v$TARGET_VERSION"

          # è¯»å– CHANGELOG å†…å®¹
          CHANGELOG_CONTENT=""
          if [ -f "docs/content/CHANGELOG.md" ]; then
            # æå–æœ€æ–°ç‰ˆæœ¬çš„ changelog
            awk "/^## \\[$TARGET_VERSION\\]/{flag=1; next} /^## \\[/{flag=0} flag" docs/content/CHANGELOG.md > /tmp/changelog.md
            CHANGELOG_CONTENT=$(cat /tmp/changelog.md)
          fi

          # å¦‚æœæ²¡æœ‰ changelogï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT=$(printf "## æ›´æ–°å†…å®¹\n\nç‰ˆæœ¬ %s å‘å¸ƒå®Œæˆã€‚\n\n### ä¸»è¦æ”¹åŠ¨\n- è¯¦ç»†å˜æ›´è¯·æŸ¥çœ‹ git commit å†å²" "$TARGET_VERSION")
          fi

          # åˆ›å»º GitHub Release
          gh release create v$TARGET_VERSION \
            --title "$RELEASE_TITLE" \
            --notes "$CHANGELOG_CONTENT" \
            --latest

          echo "âœ… Git Tag å’Œ GitHub Release åˆ›å»ºå®Œæˆ"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f .changeset/temp-release-*.md
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: å®Œæˆå‘å¸ƒ
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          echo ""
          echo "ğŸ‰ å‘å¸ƒæµç¨‹å®Œæˆï¼"
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯ï¼š"
          echo "   - ç‰ˆæœ¬: $TARGET_VERSION"
          echo "   - ç±»å‹: ${{ steps.parse-version.outputs.version_type }}"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "   - æ¨¡å¼: é¢„æ¼”æ¨¡å¼ï¼ˆå®é™…ä¸Šæœªå‘å¸ƒï¼‰"
          else
            echo "   - æ¨¡å¼: æ­£å¼å‘å¸ƒ"
            echo "   - NPM: âœ… å·²å‘å¸ƒ"
            echo "   - GitHub Release: âœ… å·²åˆ›å»º"
            echo "   - Git Tag: âœ… å·²åˆ›å»º"
          fi
