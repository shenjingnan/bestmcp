name: NPM 发布

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "目标版本号 (例如: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "预演模式"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM 发布
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 验证
        run: |
          echo "当前分支: ${{ github.ref_name }}"
          echo "目标版本: ${{ github.event.inputs.target_version }}"
          echo "预演模式: ${{ github.event.inputs.dry_run }}"

          # 验证版本号格式
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "❌ 版本号格式无效，请使用以下格式之一："
            echo "   - 正式版: 1.0.0"
            echo "   - Beta版: 1.0.0-beta.0"
            echo "   - RC版: 1.0.0-rc.0"
            exit 1
          fi

          # 检查分支权限（允许在feature分支进行测试发布）
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "❌ 正式版发布必须在主分支进行"
              exit 1
            fi
          fi

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"
          registry-url: "https://registry.npmjs.org"

      - name: 安装依赖
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: 配置 Git 用户
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 发布
        run: |
          pnpm changeset add --empty && pnpm changeset version && pnpm changeset publish
